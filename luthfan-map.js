$(document).on("keypress","#dform_widget_txt_postcode",function(){13==event.keyCode&&(event.preventDefault(),searchBegin())});var Map,Point,SimpleMarkerSymbol,Graphic,GraphicsLayer,InfoWindow,Circle,Units,GeometryService,SpatialReference,Color,Popup,Geocoder,OverviewMap,Identify,Find,InfoTemplate,PictureMarkerSymbol,mapScriptStatus=jQuery.Deferred();require(["esri/map","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol","esri/symbols/PictureMarkerSymbol","esri/graphic","esri/layers/GraphicsLayer","esri/dijit/InfoWindow","esri/geometry/Circle","esri/units","esri/tasks/GeometryService","esri/SpatialReference","esri/Color","esri/dijit/Popup","esri/dijit/Geocoder","esri/dijit/OverviewMap","esri/tasks/identify","esri/tasks/find","esri/InfoTemplate","esri/symbols/PictureMarkerSymbol","dojo/domReady!"],function(e,a,t,r,o,s,n,i,l,c,p,m,d,u,g,f,y,h,r){Map=e,Point=a,SimpleMarkerSymbol=t,PictureMarkerSymbol=r,Graphic=o,GraphicsLayer=s,InfoWindow=n,Circle=i,Units=l,GeometryService=c,SpatialReference=p,Color=m,Popup=d,Geocoder=u,OverviewMap=g,Identify=f,Find=y,InfoTemplate=h,PictureMarkerSymbol=r,mapScriptStatus.resolve(),$(formName()).trigger("_map_classesLoaded")});var mapParams={extent:[334905.5753111506,310733.193633054,680181.2782575564,663544.2449834899],WKID:27700,WKIDProj4:"+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",geolocateButton:!0,geolocateAuto:!1,geolocateWKID:4326,geolocateWKIDProj4:"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",centerLonLat:{x:325226.83303699945,y:673836.5572347812},centerZoom:1,geometryServer:"https://edinburghcouncilmaps.info/arcgis/rest/services/Utilities/Geometry/GeometryServer",drawWindowMultiplier:1.25,selectMultiple:!0,selectStorage:[{points:[],uniqueField:"FEATURE_ID",selectedAssets:["RHF12","RHF10","RHF24"],selectSymbol:{color:[4,4,100],size:"5",outline:{color:[100,6,6],width:"1"}},wkid:27700}],searchURL:{base:"https://edinburghcouncilmaps.info/locatorhub/arcgis/rest/services/CAG/POSTCODE/GeocodeServer/findAddressCandidates?&SingleLine=&Fuzzy=true&outFields=*&maxLocations=2000&f=pjson&outSR=27700",varParams:["LH_POSTCODE"]},baseLayerService:"https://edinburghcouncilmaps.info/arcgis/rest/services/Basemaps/BasemapColour/MapServer/find",backgroundMapService:"https://edinburghcouncilmaps.info/arcgis/rest/services/Basemaps/BasemapColour/MapServer",addressSearchService:{base:"https://edinburghcouncilmaps.info/locatorhub/arcgis/rest/services/CAG/ADDRESS/GeocodeServer/reverseGeocode?distance=300&outSR=27700&f=json"},processResultURL:"https://my.edinburgh.gov.uk/ci/AjaxCustom/cagSearch"};function getMapParams(){return mapParams}function deleteMapParam(e){var a=JSON.parse(JSON.stringify(getMapParams()[e])),t=delete getMapParams()[e];$(formName()).trigger("_map_paramDeleted",[e,t,a])}function setMapParams(e){for(var a in e)getMapParams()[a]=e[a]}var specifics=mapParams;function setSpecifics(e){setMapParams(e)}function getSpecifics(){getMapParams()}function drawAssetLayer(e){var a;a=null!==e&&Array.isArray(e)?e:[],KDF.hideMessages();var t=getWindowDrawBounds({xMax:esrimap.extent.xmax,yMax:esrimap.extent.ymax,xMin:esrimap.extent.xmin,yMin:esrimap.extent.ymin}),r=[],o=getCommunalAssetURl()+"&geometry=%7B%22xmin%22%3A"+t.xMin+"%2C%22ymin%22%3A"+t.yMin+"%2C%22xmax%22%3A"+t.xMax+"%2C%22ymax%22%3A"+t.yMax+"%2C%22spatialReference%22%3A%7B%22wkid%22%3A"+getMapParams().WKID+"%7D%7D";$.ajax({url:o,dataType:"jsonp",crossDomain:!0}).done(function(e){var t;e.features.forEach(function(e){var a=!0;getMapParams().selectStorage.forEach(function(t){t.selectedAssets.includes(e.attributes[t.uniqueField])&&(t.points.push([e.geometry.x,e.geometry.y]),a=!1)}),a&&r.push([e.geometry.x,e.geometry.y])}),t=getMapParams().markerSymbol?getMapParams().markerSymbol:{color:[0,204,153],size:"12",outline:{color:[0,153,255],width:"5px"}};var o=JSON.parse(JSON.stringify(getMapParams().selectStorage));o.push({points:r,uniqueField:!1,selectedAssets:!0,selectSymbol:t,wkid:getMapParams().WKID}),getMapParams().selectStorage.forEach(function(e){e.points=[]}),o.forEach(function(e){e.points=new esri.geometry.Multipoint({points:e.points,spatialReference:{wkid:e.wkid}}),e.selectSymbol=new SimpleMarkerSymbol(e.selectSymbol),e.graphic=new esri.Graphic(e.points,e.selectSymbol),e.graphic.setAttributes({title:(new Date).getTime()}),a.unshift(e.graphic),e.graphic.geometry.points.length>0&&esrimap.graphics.add(e.graphic)}),removeLayers(esrimap.graphics,a)}).fail(function(){KDF.showError("It looks like the connection to our mapping system has failed, please try to log the fault again")})}function getWindowDrawBounds(e){var a=1;return null!==getMapParams().drawWindowMultiplier&&(a=getMapParams().drawWindowMultiplier),{xMax:e.xMax+(a-1)*(e.xMax-e.xMin),yMax:e.yMax+(a-1)*(e.yMax-e.yMin),xMin:e.xMin-(a-1)*(e.xMax-e.xMin),yMin:e.yMin-(a-1)*(e.yMax-e.yMin)}}function removeLayers(e,a){for(var t=0;t<e.graphics.length;t++){var r=!0;a.forEach(function(a){e.graphics[t]==a&&(r=!1)}),r&&e.remove(e.graphics[t])}}function replaceSymbol(e,a,t,r){}function removeSelectedAssets(e){}function getAssetInfoFromCoord(e){}var faultReportingSearchResults=new Object,streetAddress="";function getCommunalAssetURl(){if(KDF.getVal("asset_layer"))return getMapParams().assetURL="https://edinburghcouncilmaps.info/arcgis/rest/services/CouncilAssets/ConfirmAssets2/MapServer/"+KDF.getVal("asset_layer")+"/query?f=pjson&returnGeometry=true&spatialRel=esriSpatialRelIntersects&geometryType=esriGeometryEnvelope&inSR=27700&outFields=*&outSR=27700&transformForward=false",getMapParams().assetURL;if(getMapParams().assetURL)return getMapParams().assetURL;if(!getMapParams().formName)return!1;if("road_sign"===getMapParams().formName){if("unlit"===KDF.getVal("rad_problem_type"))return getMapParams().assetURL="https://edinburghcouncilmaps.info/arcgis/rest/services/CouncilAssets/ConfirmAssets2/MapServer/7/query?f=pjson&returnGeometry=true&spatialRel=esriSpatialRelIntersects&geometryType=esriGeometryEnvelope&inSR=27700&outFields=*&outSR=27700&transformForward=false",getMapParams().assetURL;if("lit"===KDF.getVal("rad_problem_type"))return getMapParams().assetURL="https://edinburghcouncilmaps.info/arcgis/rest/services/CouncilAssets/ConfirmAssets2/MapServer/3/query?f=pjson&returnGeometry=true&spatialRel=esriSpatialRelIntersects&geometryType=esriGeometryEnvelope&inSR=27700&outFields=*&outSR=27700&transformForward=false",getMapParams().assetURL}}function postcodeSearch(e){var a,t,r=getMapParams().searchURL.base;r+="&LH_POSTCODE="+e,$.ajax({url:r,dataType:"jsonp",crossDomain:!0}).done(function(e){if(0!==e.candidates.length){$.each(e.candidates,function(e,r){a=r.location.x,t=r.location.y}),hideLoading();new Point(a,t,new esri.SpatialReference({wkid:getMapParams().WKID}));var r=new Point(a,t,new esri.SpatialReference({wkid:getMapParams().WKID}));esrimap.centerAndZoom(r,5)}else KDF.showWidget("html_nosearchfound"),hideLoading()}).fail(function(){KDF.showError("We where unable to complete a postcode search - please ensure a valid postcode was used")})}function getAssetInfo(e,a){clearPreviousLayer();new Point([e,a]);var t,r=new Point(e,a,new esri.SpatialReference({wkid:getMapParams().WKID})),o=new Circle(r,{radius:15,numberOfPoints:4,radiusUnit:Units.METERS,type:"extent"}),s="";showLoading();var n=o.getExtent().xmax,i=o.getExtent().ymax,l=o.getExtent().xmin,c=o.getExtent().ymin;t=getCommunalAssetURl()+"&geometry=%7B%22xmin%22%3A"+l+"%2C%22ymin%22%3A"+c+"%2C%22xmax%22%3A"+n+"%2C%22ymax%22%3A"+i+"%2C%22spatialReference%22%3A%7B%22wkid%22%3A"+getMapParams().WKID+"%7D%7D",$.ajax({url:t,dataType:"jsonp",crossDomain:!0}).done(function(e){hideLoading(),console.groupCollapsed("Feature responces:"),console.log("Actual responce (we should implement the closest one soon):"),console.log(e),$.each(e.features,function(e,a){if(s="",KDF.getVal("asset_popup_fields"));else if(console.log(a.attributes.FEATURE_ID),console.log(a),getMapParams().popupFields)getMapParams().popupFields.forEach(function(e){s+="<b>"+e[0]+"</b>"+a.attributes[e[1]]+"</br>"}),getMapParams().popupConfirmText?s+='</br><button id="" class="mapConfirm btn-continue" data-asset_id="">'+getMapParams().popupConfirmText+"</button></div>":s+='</br><button id="" class="mapConfirm btn-continue" data-asset_id="">Confirm</button></div>';else if(getMapParams().formName){if("road_sign"===getMapParams().formName){var t=a.attributes;s="<b>Asset ID</b> : "+t.ASSET_ID+"</br><b>Location : </b>"+t.LOCATION+"</br><b>Site Name : </b>"+t.SITE_NAME+"</br><b>Type Name : </b>"+t.TYPE_NAME+'</br></br><button id="" class="mapConfirm btn-continue" data-asset_id="">Report this sign</button></div>'}"communal_bin"===getMapParams().formName&&(s="<b>Asset ID</b> : "+a.attributes.ASSET_ID+"</br><b>Location : </b>"+a.attributes.feature_location+"</br><b>Site Name : </b>"+a.attributes.site_name+'</br></br><button id="" class="mapConfirm btn-continue" data-asset_id="">Report this bin</button></div>')}else s="<b>Asset ID</b> : "+a.attributes.ASSET_ID+"</br><b>Location : </b>"+a.attributes.feature_location+"</br><b>Site Name : </b>"+a.attributes.site_name+'</br></br><button id="" class="mapConfirm btn-continue" data-asset_id="">Report this bin</button></div>'}),console.groupEnd();var a=new GraphicsLayer,o=new PictureMarkerSymbol("/dformresources/content/map-blue.png",64,64);o.setOffset(0,32);var n=new Graphic(r,o);a.add(n),a.on("click",function(e){callInfoWindow(s,n,esrimap)}),esrimap.addLayer(a),callInfoWindow(s,n,esrimap),$(formName()).trigger("_map_assetInfoReturned",[s,t]),esrimap.centerAndZoom(r,null!=esrimap.getLevel()?esrimap.getLevel():1)}).fail(function(){KDF.showError("Was unable to get asset details at this time, please try again")})}function callInfoWindow(e,a,t){console.groupCollapsed("infowindow content:"),console.log(e),console.groupEnd(),null!=e&&""!=e||(e=getMapParams().defaultPopupContent?getMapParams().defaultPopupContent instanceof Function?getMapParams().defaultPopupContent():getMapParams().defaultPopupContent:'<u><b>Asset not found.</b></u></br></br><u><b>If you believe there is an asset here please click below button to report.</b></u></br></br><button id="" class="mapConfirm btn-continue" data-asset_id="">Report this location</button></div>');var r=new Point(a.geometry.x,a.geometry.y,new esri.SpatialReference({wkid:getMapParams().WKID}));t.infoWindow.setTitle(""),t.infoWindow.setContent(e),t.infoWindow.show(r),drawAssetLayer()}function zoomChanged(e){console.log("Zoom: "+e.lod.level),1==e.levelChange&&console.log("Zoom: "+e.lod.level),getMapParams().assetMaxDrawZoom?e.lod.level>=getMapParams().assetMaxDrawZoom||esrimap.graphics.clear():(console.log("level undefined"),e.lod.level>=6?getOpenCaseMarker():esrimap.graphics.clear())}function callEsriSearch(e){var a=getMapParams().baseLayerService;find=new esri.tasks.FindTask(a),findparams=new esri.tasks.FindParameters,findparams.contains=!0,findparams.returnGeometry=!0,findparams.layerIds=[7],findparams.searchFields=[""],findparams.outSpatialReference=new esri.SpatialReference({wkid:4326}),findparams.searchText=e,find.execute(findparams,processResult)}function mapClicked(e,a){console.log("long : "+e.geometry.x+" lat : "+e.geometry.y+KDF.getVal("le_gis_rgeo_desc")),esrimap.graphics.clear();var t=a.graphicsLayerIds,r=t.length;console.log("length before: "+r),esrimap.getLayer(t[r-1]).clear();for(var o=0;o<r;o++){a.getLayer(t[o]).clear()}getAssetInfo(e,a)}function getVenue(e,a){console.log("get venue is called"),clearPreviousLayer(),showLoading();var t=new GraphicsLayer,r=parseInt(e),o=parseInt(a);console.log("ini geometry x "+r);var s=getMapParams().addressSearchService.base;s+="&location="+r+"%2C+"+o,console.log(s);var n=getWindowDrawBounds({xMax:esrimap.extent.xmax,yMax:esrimap.extent.ymax,xMin:esrimap.extent.xmin,yMin:esrimap.extent.ymin}),i=new Point(r,o,new esri.SpatialReference({wkid:getMapParams().WKID}));$.ajax({url:s,crossDomain:!0}).done(function(e){streetAddress=e.address,console.log(e.address),hideLoading(),console.log(streetAddress.Address);var a=streetAddress.Address+'</callInfoWindowbr></br><button id="" class="mapConfirm btn-continue" data-asset_id="">Confirm Location</button></div>';$.each(open_case_resp.data,function(e,a){if(n.xMax>=a.longitude&&n.yMax>=a.latitude&&n.xMin<=a.longitude&&n.yMin<=a.latitude){var t=new Point(Number(a.longitude),Number(a.latitude),new esri.SpatialReference({wkid:getMapParams().WKID})),r=new PictureMarkerSymbol("/dformresources/content/map-green.png",64,64);r.setOffset(0,0);var o=new Graphic(t,r);o.setAttributes({title:"",description:a.description}),esrimap.graphics.add(o),$(formName()).trigger("_map_caseMarkerDisplayed",[a.longitude,a.latitude,getMapParams().WKID,a.description])}});var s=new PictureMarkerSymbol("/dformresources/content/map-blue.png",64,64);s.setOffset(0,32);var l=new Graphic(i,s);l.setAttributes({value1:"1",value2:"2",value3:"3"}),t.add(l),t.on("click",function(e){setInfoWindowContent(a,r,o)}),esrimap.addLayer(t),setInfoWindowContent(a,r,o)}).fail(function(){KDF.showError("It looks like the connection to our mapping system has failed, please try to log the fault again")})}function highlightMissingAsset(e,a){clearPreviousLayer(),showLoading();var t=new GraphicsLayer,r=parseInt(e),o=parseInt(a);console.log("ini geometry x "+r);var s=getMapParams().addressSearchService.base;s+="&location="+r+"%2C+"+o,console.log(s);var n=new Point(r,o,new esri.SpatialReference({wkid:getMapParams().WKID}));$.ajax({url:s,crossDomain:!0}).done(function(e){var a="";if(hideLoading(),""==e)a='<p class="p-m">Report location<p/><br/><button id="" class="mapConfirm btn-continue" data-asset_id="">Confirm Location</button></div>';else{var s=e.address;a=s.Address+'</callInfoWindowbr></br><button id="" class="mapConfirm btn-continue" data-asset_id="">Confirm Location</button></div>'}var i=new PictureMarkerSymbol("/dformresources/content/map-blue.png",64,64);i.setOffset(0,32);var l=new Graphic(n,i);l.setAttributes({value1:"1",value2:"2",value3:"3"}),t.add(l),t.on("click",function(e){setInfoWindowContent(a,r,o)}),esrimap.addLayer(t),setInfoWindowContent(a,r,o)}).fail(function(){KDF.showError("It looks like the connection to our mapping system has failed, please try to log the fault again")}),streetAddress&&(console.log("udah nich"),getOpenCaseMarker()),console.log(esrimap)}function processResult(e){KDF.hideMessages();var a=0,t=new Object;$.ajax({url:getMapParams().processResultURL,crossDomain:!0,method:"POST",data:{w_id:"6",search_term:e,search_type:"street"}}).done(function(e){var r,o,s,n;(console.log(e),0===e.length)?(KDF.showWidget("html_nosearchfound"),hideLoading()):($.each(jQuery.parseJSON(e),function(e,a){t[a.Abbreviation]=new Object,t[a.Abbreviation].site_name=a.Abbreviation,t[a.Abbreviation].xmax=a.Street_Start_X,t[a.Abbreviation].ymax=a.Street_Start_Y,t[a.Abbreviation].xmin=a.Street_End_X,t[a.Abbreviation].ymin=a.Street_End_Y}),console.log(t),$.each(jQuery.parseJSON(e),function(e,t){a++}),console.log(a),1==a?($.each(t,function(e,a){r=parseFloat(a.xmax),o=parseFloat(a.xmin),s=parseFloat(a.ymax),n=parseFloat(a.ymin)}),centreOnEsriResult("","",r,o,s,n,"","")):($("label[for=dform_widget_fault_reporting_search_results]").html('<label for="dform_widget_fault_reporting_search_results">Multiple results, please select one:</label>'),$("#dform_widget_fault_reporting_search_results").append($("<option>",{value:"Please select a location",text:"Please select"})),$.each(t,function(e,a){console.log(a.site_name),$("#dform_widget_fault_reporting_search_results").append($("<option>",{value:a.site_name,text:a.site_name})),KDF.showWidget("fault_reporting_search_results")})));faultReportingSearchResults=t,hideLoading()}).fail(function(){KDF.showError("It looks like request blocked by the CROSS Origin Policy, contact the system administrator"),hideLoading()})}function setInfoWindowContent(e,a,t){if(void 0===esrimap||void 0===esrimap.infoWindow)KDF.showError("Unable to populate case details, popup does not exist.");else{var r=new Point(a,t,new esri.SpatialReference({wkid:getMapParams().WKID}));esrimap.infoWindow.setTitle("Please confirm street address."),esrimap.infoWindow.setContent(e),esrimap.infoWindow.show(r);var o=new Point(a,t,new esri.SpatialReference({wkid:getMapParams().WKID}));esrimap.centerAndZoom(o,esrimap.getLevel())}}function showLoading(){KDF.showWidget("ahtm_cool_loading_gif"),changeAllLayersOpacity("0.2"),esrimap.disableMapNavigation(),esrimap.hideZoomSlider()}function hideLoading(e){KDF.hideWidget("ahtm_cool_loading_gif"),changeAllLayersOpacity("0.9"),esrimap.enableMapNavigation(),esrimap.showZoomSlider()}function searchBegin(){KDF.hideMessages(),searchInput=KDF.getVal("txt_postcode"),$("#dform_widget_fault_reporting_search_results").empty(),KDF.hideWidget("fault_reporting_search_results"),KDF.hideWidget("html_nosearchfound"),showLoading(),"E"!==searchInput.charAt(0)?processResult(searchInput):postcodeSearch(searchInput)}function changeAllLayersOpacity(e){for(var a=esrimap.layerIds,t=a.length,r=0;r<t;r++){esrimap.getLayer(a[r]).setOpacity(e)}}function drawBaseLayer(){var e=getMapParams().backgroundMapService;bglayer=new esri.layers.ArcGISTiledMapServiceLayer(e,{opacity:1,id:"bglayer"}),esrimap.addLayer(bglayer)}function drawResultsLayer(){resultslayer=new esri.layers.GraphicsLayer({id:"resultslayer"}),esrimap.addLayer(resultslayer)}function clearPreviousLayer(){esrimap.graphics.clear();var e=esrimap.graphicsLayerIds,a=e.length;esrimap.getLayer(e[a-1]).clear();for(var t=0;t<a;t++){esrimap.getLayer(e[t]).clear()}}function centreOnEsriResult(e,a,t,r,o,s,n,i){if(""!=a){var l=new GraphicsLayer,c=e,p=a;console.log(c);var m=new Point(c,p,new esri.SpatialReference({wkid:getMapParams().WKID}));esrimap.centerAndZoom(new Point(c,p),esrimap.getLevel());var d=new PictureMarkerSymbol("/dformresources/content/map-red.png",64,64);d.setOffset(0,32);var u=new Graphic(m,d);u.setAttributes({value1:"1",value2:"2",value3:"3"}),l.add(u),esrimap.addLayer(l)}else if(""!=s){var g=new esri.SpatialReference({wkid:getMapParams().WKID}),f=new esri.geometry.Extent(t,o,r,s,g);esrimap.setExtent(f)}else if(""!=n){var y=parseInt(i),h=parseInt(n);g=new esri.SpatialReference({wkid:getMapParams().WKID}),f=new esri.geometry.Extent(y-250,h-250,y+250,h+250,g);esrimap.setExtent(f)}}function distanceBetweenPoints(e,a,t,r){var o=Math.PI,s=e*(o/180),n=t*(o/180),i=o/180*(t-e),l=o/180*(r-a),c=Math.sin(i/2)*Math.sin(i/2)+Math.cos(s)*Math.cos(n)*Math.sin(l/2)*Math.sin(l/2);return 6371e3*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function isPointInPolygon(e,a){for(var t=e[0],r=e[1],o=!1,s=0,n=a.length-1;s<a.length;n=s++){var i=a[s][0],l=a[s][1],c=a[n][0],p=a[n][1];l>r!=p>r&&t<(c-i)*(r-l)/(p-l)+i&&(o=!o)}return o}function isPointWithinSquare(e,a){return isPointInPolygon([e[0],e[1]],[[a[0],a[2]],[a[1],a[2]],[a[1],a[3]],[a[0],a[3]]])}function popupOrZoomTo(e,a){var t=a;return getMapParams().assetMaxDrawZoom?!(getMapParams().assetMaxDrawZoom>e.getLevel())||(e.centerAndZoom(t,getMapParams().assetMaxDrawZoom),!1):!(6>e.getLevel())||(e.centerAndZoom(t,6),!1)}function convertLonLat(e,a,t,r){if(a.type&&"Proj4"==a.type){var o=proj4(a.projection,t.projection,e);r({x:o[0],y:o[1],WKID:t.WKID})}else{var s=e[0],n=e[1],i=(new SpatialReference({wkid:a}),new SpatialReference({wkid:t})),l=getMapParams().geometryServer+"/project?f=pjson&inSR="+a+"&outSR="+t+"&geometries=%7B%22geometryType%22%3A%22esriGeometryPoint%22%2C%22geometries%22%3A%5B%7B%22x%22%3A"+s+"%2C%22y%22%3A"+n+"%7D%5D%7D";$.ajax({url:l,dataType:"jsonp",crossDomain:!0}).done(function(e){return r({x:e.geometries[0].x,y:e.geometries[0].y,WKID:i})}).fail(function(e){return r(!1)})}}function geolocate(){navigator.geolocation?(navigator.geolocation.getCurrentPosition(function(e){console.log(e),convertLonLat([e.coords.longitude,e.coords.latitude],{WKID:getMapParams().geolocateWKID,projection:getMapParams().geolocateWKIDProj4,type:"Proj4"},{WKID:getMapParams().WKID,projection:getMapParams().WKIDProj4,type:"Proj4"},geolocateLogic)}),console.log("geolocate working")):console.log("navigator.geolocation undefined")}function geolocateLogic(e){if(e){var a=new Point(e.x,e.y,e.WKID);console.log(a);var t=isPointWithinSquare([a.x,a.y],getMapParams().extent);if(t)esrimap.centerAndZoom(a,getMapParams().assetMaxDrawZoom?getMapParams().assetMaxDrawZoom:6).then(drawAssetLayer());else{var r=new Point(getMapParams().centerLonLat.x,getMapParams().centerLonLat.y,new SpatialReference(getMapParams().WKID));esrimap.centerAndZoom(r,getMapParams().centerZoom)}$(formName()).trigger("_map_geolocated",[a.x,a.y,t])}else console.log("Couldn't geolocate - point was undefined")}function addGeolocateButton(e){var a=getMapParams().locateChar?getMapParams().locateChar:"⌕",t=e.find("> .esriMapContainer"),r='<div class="esriSimpleSlider esriLocateButton" style="z-index: 30;top: 82px;left: 20px;"><div title="Locate"><span>'+a+"</span></div></div>";t.prepend(r),$(".esriLocateButton").off("click").on("click",function(){geolocate()}),$(formName()).trigger("_map_geolocateButtonAdded",[t.find(".esriLocateButton"),r])}function parseRSMarker(e){var a=getWindowDrawBounds({xMax:esrimap.extent.xmax,yMax:esrimap.extent.ymax,xMin:esrimap.extent.xmin,yMin:esrimap.extent.ymin});console.log("1"),$.each(e.data,function(e,t){if(a.xMax>=t.longitude&&a.yMax>=t.latitude&&a.xMin<=t.longitude&&a.yMin<=t.latitude){var r=new Point(Number(t.longitude),Number(t.latitude),new esri.SpatialReference({wkid:getMapParams().WKID})),o=new PictureMarkerSymbol(t.icon,64,64);o.setOffset(0,0);var s=new Graphic(r,o);s.setAttributes({title:"",description:t.description}),esrimap.graphics.add(s),$(formName()).trigger("_map_caseMarkerDisplayed",[t.longitude,t.latitude,getMapParams().WKID,t.description])}}),console.log("2")}function formName(){return KDF.kdf().name?"#dform_"+KDF.kdf().name:"#dform_container"}function getOpenCaseMarker(){KDF.getVal("txt_eventcode")&&(console.log("mantap"),void 0!==typeof KDF.getVal("txt_customer_id")&&""!==KDF.getVal("txt_customer_id")?sx_customer_id=KDF.getVal("txt_customer_id"):""===KDF.getVal("txt_customer_id")&&(sx_customer_id="999999999"),console.log(sx_customer_id),KDF.customdata("open_case_marker","create",!0,!0,{eventcode:"4001013",customerid:sx_customer_id}),KDF.unlock())}$(document).on("click",".mapConfirm",function(){KDF.setVal("txt_issuestreet",KDF.getVal("le_gis_rgeo_desc")),KDF.gotoNextPage()}),$(document).on("click","#dform_widget_button_but_search",function(){$("#dform_widget_txt_postcode").hasClass("dform_fielderror")||searchBegin()}),$(document).on("click","#dform_widget_button_but_nextcall",function(){if(null!==esrimap){clearPreviousLayer(),esrimap.infoWindow.hide(),drawBaseLayer();var e=new Point(325375,673865,new esri.SpatialReference({wkid:getMapParams().WKID}));esrimap.centerAndZoom(e,2),drawAssetLayer()}}),$(document).on("change","#dform_widget_fault_reporting_search_results",function(){var e=$("select#dform_widget_fault_reporting_search_results option:checked").val();""!==e&&$.each(faultReportingSearchResults,function(a,t){e==t.site_name&&(void 0!==t.east&&""!==t.east&&void 0!==t.north&&""!==t.north?centreOnEsriResult("","","","","","",t.north,t.north):centreOnEsriResult("","",parseFloat(t.xmax),parseFloat(t.xmin),parseFloat(t.ymax),parseFloat(t.ymin),"",""))})}),$(formName()).on("_style_fileUploaded",function(e,a,t,r){console.log("currentCount :"+a)});
